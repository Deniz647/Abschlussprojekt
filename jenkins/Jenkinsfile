pipeline {
    agent any

    stages {
        stage("Build Backend") {
            steps {
                dir("backend") {
                    sh "mvn clean install -Pdev -DskipTests"
                }
            }
        }

        stage("Build Frontend") {
            steps {
                dir("frontend") {
                    sh "npm install"
                    sh "npm run build"
                }
            }
        }

        stage("Test Backend") {
            steps {
                dir("backend") {
                    sh "mvn test -Pdev"
                }
            }
        }

        stage("Test Frontend") {
            steps {
                dir("frontend") {
                    sh "npm test"
                }
            }
        }

        stage("Docker Build") {
            steps {
                script {
                    sh "docker build -t skyerededucation.azurecr.io/abschlussprojekt:latest ."
                }
            }
        }

        stage("Docker Push") {
            steps {
                script {
                    sh "docker push skyerededucation.azurecr.io/abschlussprojekt:latest"
                }
            }
        }

        stage("Deploy Dev") {
            steps {
                script {
                    sh "kubectl apply -f kubernetes/frontend-deployment-dev.yaml --namespace=dev"
                    sh "kubectl apply -f kubernetes/frontend-service-dev.yaml --namespace=dev"
                    sh "kubectl apply -f kubernetes/backend-deployment-dev.yaml --namespace=dev"
                    sh "kubectl apply -f kubernetes/backend-service-dev.yaml --namespace=dev"
                }
            }
        }
    }
}
